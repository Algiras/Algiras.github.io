<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lithuanian Real Estate Tax Calculator (Before vs. After 2026 Reform)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Apply Inter font globally */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Lighter gray background */
        }
        /* Input field base styles */
        .form-input {
            @apply w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out text-sm; /* Added focus:ring-2 */
        }
        /* Label styles */
        .form-label {
            @apply block text-sm font-medium text-gray-700 mb-1.5; /* Increased bottom margin */
        }
        /* Button base styles */
        .btn { /* Primary Button */
            @apply inline-flex items-center justify-center px-6 py-2 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out disabled:opacity-50;
        }
         .btn-secondary { /* Secondary Button - Updated Style */
             @apply inline-flex items-center justify-center px-4 py-2 border border-indigo-300 rounded-md shadow-sm text-sm font-medium text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out; /* Added background, adjusted hover/border */
         }
        /* Result section container */
        .result-section {
            @apply mt-8 p-4 md:p-6 bg-white rounded-lg shadow;
        }
        .result-title {
            @apply text-xl font-semibold text-gray-800 mb-6 text-center;
        }
        /* Grid for comparison results */
        .comparison-grid {
            @apply grid grid-cols-1 md:grid-cols-2 gap-6;
        }
        .result-column {
            @apply p-4 bg-gray-50 rounded-lg border border-gray-200;
        }
        .column-title {
            @apply text-lg font-semibold text-indigo-700 mb-3 border-b border-indigo-200 pb-2;
        }
        /* Individual result lines */
        .result-item {
            @apply flex justify-between items-center py-2 border-b border-gray-100;
        }
        .result-label {
            @apply text-xs text-gray-600 mr-2;
        }
        .result-value {
            @apply text-sm font-medium text-gray-900 text-right;
        }
        /* Final tax line styling */
        .final-tax-item {
             @apply flex justify-between items-center pt-3 mt-3 border-t-2 border-gray-300;
        }
         .final-tax-label {
            @apply text-base font-semibold text-gray-800;
        }
         .final-tax-value {
            @apply text-base font-bold text-indigo-700 text-right;
        }
        /* Notes, Definitions, Resources styling */
        .note, .definition, .resources {
            @apply mt-6 text-xs text-gray-600;
        }
         .definition {
             @apply p-3 bg-yellow-50 border border-yellow-200 rounded-md text-yellow-900;
         }
         .resources {
             @apply mt-8 pt-4 border-t border-gray-200;
         }
         .resources h4 {
              @apply text-sm font-semibold text-gray-700 mb-2;
         }
         .resources ul {
             @apply list-disc list-inside space-y-1.5;
         }
         .resources a {
             @apply text-indigo-600 hover:text-indigo-800 hover:underline;
         }
        /* Checkbox styling */
        .form-checkbox {
            @apply h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500;
        }
        .checkbox-label {
             @apply text-sm text-gray-700;
        }
        /* Summary section styling */
        .summary-section {
            @apply mt-6 p-4 bg-indigo-50 rounded-lg border border-indigo-200 text-center;
        }
        .summary-title {
             @apply text-base font-semibold text-indigo-800 mb-1;
        }
         .summary-value {
             @apply text-lg font-bold text-indigo-900;
         }
         /* Input summary grid */
         .input-summary-grid {
             @apply grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1.5 text-xs;
         }
         .input-summary-grid span { @apply text-gray-700; }
         .input-summary-grid strong { @apply font-semibold text-gray-900; }

         /* Conditional display for sections */
         #abandoned-rate-section.hidden, #explanation-section.hidden {
            display: none;
         }
         /* Explanation section styling */
         #explanation-section {
             @apply mt-6 p-4 md:p-6 bg-white border border-gray-200 rounded-lg text-sm shadow;
         }
         #explanation-section h3 {
             @apply text-lg font-semibold text-gray-800 mb-4 text-center;
         }
         #explanation-section h4 {
              @apply text-base font-semibold text-gray-700 mt-5 mb-2;
         }
          #explanation-section h5 {
              @apply text-sm font-semibold text-gray-600 mt-4 mb-1;
         }
         #explanation-section p {
             @apply mb-2 text-sm text-gray-700 leading-relaxed;
         }
         /* Grid layout for explanation comparison */
         .explanation-grid {
             @apply grid grid-cols-1 md:grid-cols-2 gap-6 mt-4 mb-4;
         }
         .explanation-column {
              @apply p-4 bg-gray-50 border border-gray-200 rounded-lg;
         }
         .explanation-column h4 {
             @apply text-base font-semibold text-indigo-700 mb-3 border-b border-indigo-100 pb-2;
         }
         /* Style for calculation lines */
         #explanation-section .calculation-step {
             @apply my-1.5 py-2 px-3 bg-white border border-gray-200 rounded-md text-sm flex justify-between items-center;
         }
         /* Specific style for steps within columns */
         .explanation-column .calculation-step {
              @apply bg-white border-gray-200;
         }
          #explanation-section .calculation-step span:first-child {
             @apply text-gray-600 mr-2;
          }
          #explanation-section .calculation-step span:last-child {
             @apply font-medium text-gray-900 text-right;
          }
          /* Style for the sum line */
          #explanation-section .sum-step {
              @apply mt-2 pt-2 border-t-2 border-gray-300 font-semibold;
          }
         #explanation-section ul {
             @apply list-disc list-inside text-sm pl-2 space-y-1;
         }
         #explanation-section .note-text {
              @apply text-xs text-gray-500 italic mt-1;
         }

         /* Tooltip Styles */
         .tooltip-container {
             position: relative;
             display: inline-block;
             margin-left: 4px;
         }
         .tooltip-icon {
             color: #4f46e5;
             cursor: help;
             font-size: 0.875rem;
         }
         .tooltip-text {
             visibility: hidden;
             opacity: 0;
             width: 220px;
             background-color: #374151;
             color: #fff;
             text-align: center;
             border-radius: 6px;
             padding: 8px 10px;
             position: absolute;
             z-index: 10;
             bottom: 140%;
             left: 50%;
             margin-left: -110px;
             transition: opacity 0.3s ease-in-out;
             font-size: 0.75rem;
             line-height: 1.4;
             font-weight: normal;
             box-shadow: 0 2px 5px rgba(0,0,0,0.2);
         }
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #374151 transparent transparent transparent;
        }
         .tooltip-container:hover .tooltip-text {
             visibility: visible;
             opacity: 1;
         }

    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">
    <div class="max-w-3xl mx-auto bg-white p-6 md:p-8 rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-2">Lithuanian Real Estate Tax Comparison</h1>
        <p class="text-sm text-center text-gray-600 mb-8">Estimate tax under current rules vs. proposed 2026 reform.</p>

        <form id="tax-form" class="space-y-6">

            <div class="p-5 bg-gray-50 rounded-lg border border-gray-200 space-y-5">
                <h3 class="text-lg font-semibold text-gray-900 border-b border-gray-300 pb-2 mb-4">Property Values</h3>
                 <div>
                     <label for="primary-residence-value" class="form-label">Primary Residence Value (€)
                         <span class="tooltip-container">
                             <i class="fas fa-info-circle tooltip-icon"></i>
                             <span class="tooltip-text">Official taxable value ('mokestinė vertė') from Registrų Centras. See Resources section below.</span>
                         </span>
                     </label>
                    <input type="number" id="primary-residence-value" name="primary-residence-value" class="form-input" placeholder="Enter 0 if none" value="0" required min="0" step="any">
                     <p class="text-xs text-gray-500 mt-1.5">Value of your main home.</p>
                </div>

                 <div>
                     <label for="other-properties-value" class="form-label">Other Maintained Property Value (€)
                         <span class="tooltip-container">
                             <i class="fas fa-info-circle tooltip-icon"></i>
                             <span class="tooltip-text">Total official value ('mokestinė vertė') of all other non-commercial property (secondary homes, plots, etc.). Excludes Primary Residence & Abandoned Property.</span>
                         </span>
                     </label>
                    <input type="number" id="other-properties-value" name="other-properties-value" class="form-input" placeholder="Enter 0 if none" value="0" required min="0" step="any">
                    <p class="text-xs text-gray-500 mt-1.5">Sum for secondary homes, plots, garages, etc.</p>
                </div>

                 <div>
                    <label for="abandoned-value" class="form-label">Abandoned/Neglected Property Value (€)
                         <span class="tooltip-container">
                             <i class="fas fa-info-circle tooltip-icon"></i>
                             <span class="tooltip-text">Value of property listed as neglected ('apleistas/neprižiūrimas') by the municipality. See Definition box below.</span>
                         </span>
                    </label>
                    <input type="number" id="abandoned-value" name="abandoned-value" class="form-input" placeholder="Enter 0 if none" value="0" required min="0" step="any">
                </div>

                  <div id="abandoned-rate-section" class="hidden">
                    <label for="municipal-rate" class="form-label">Municipal Rate for Abandoned Property (%)
                         <span class="tooltip-container">
                             <i class="fas fa-info-circle tooltip-icon"></i>
                             <span class="tooltip-text">Rate set by your municipality for neglected property (typically 0.5% to 3%). Check locally.</span>
                         </span>
                    </label>
                    <input type="number" id="municipal-rate" name="municipal-rate" class="form-input" placeholder="e.g., 3" value="3" min="0.5" max="3" step="0.1">
                    <p class="text-xs text-gray-500 mt-1.5">Enter rate (0.5-3%). Default is 3%.</p>
                </div>
                 <div class="definition">
                     <strong>Definition of Abandoned/Neglected Property:</strong> Municipalities classify property based on criteria like disrepair, safety hazards, lack of maintenance. Check local rules.
                 </div>
            </div>

             <div class="p-5 bg-gray-50 rounded-lg border border-gray-200 space-y-5">
                 <h3 class="text-lg font-semibold text-gray-900 border-b border-gray-300 pb-2 mb-4">Ownership & Status</h3>
                <div>
                    <label for="num-owners" class="form-label">Number of Owners</label>
                    <input type="number" id="num-owners" name="num-owners" class="form-input" placeholder="e.g., 1 or 2" required min="1" value="1">
                     <p class="text-xs text-gray-500 mt-1.5">Total owners for this property portfolio.</p>
                </div>

                <div class="flex items-center space-x-3 pt-1">
                    <input type="checkbox" id="family-status" name="family-status" class="form-checkbox">
                    <label for="family-status" class="checkbox-label">Family Adjustment?
                         <span class="tooltip-container">
                             <i class="fas fa-info-circle tooltip-icon"></i>
                             <span class="tooltip-text">Applies if raising 3+ children under 18, or raising a child with disabilities. Affects tax thresholds & proposed relief.</span>
                         </span>
                    </label>
                    <span class="text-xs text-gray-500 hidden sm:inline">(3+ children or disabled child)</span>
                </div>

                 <div class="flex items-center space-x-3">
                    <input type="checkbox" id="low-income" name="low-income" class="form-checkbox">
                    <label for="low-income" class="checkbox-label">Receive Heating Compensation?
                         <span class="tooltip-container">
                             <i class="fas fa-info-circle tooltip-icon"></i>
                             <span class="tooltip-text">Indicates low-income status, potentially waiving standard tax on primary residence. See Explanation/Disclaimer.</span>
                         </span>
                    </label>
                     <span class="text-xs text-gray-500 hidden sm:inline">(Social assistance)</span>
                </div>
             </div>

            <div class="text-center pt-4">
                <button type="submit" id="calculate-btn" class="btn w-full md:w-auto">
                     <i class="fas fa-calculator mr-2"></i> Calculate & Compare Tax
                </button>
            </div>
        </form>

        <div id="results" class="result-section hidden">
            <h2 class="result-title">Estimated Tax Comparison (Annual)</h2>
            <div class="mb-6 p-4 bg-gray-100 rounded-lg border border-gray-200">
                 <h3 class="font-semibold text-sm text-gray-700 mb-2 text-center">Calculation Inputs Summary</h3>
                 <div class="input-summary-grid">
                    <span>Primary Residence: <strong id="summary-pr-value"></strong></span>
                    <span>Other Maintained: <strong id="summary-other-value"></strong></span>
                    <span>Abandoned Property: <strong id="summary-abandoned-value"></strong></span>
                    <span id="summary-municipal-rate-span" class="hidden">Municipal Rate: <strong id="summary-municipal-rate"></strong>%</span>
                    <span>Owners: <strong id="summary-num-owners"></strong></span>
                    <span>Family Adjustment: <strong id="summary-family-status"></strong></span>
                    <span>Low Income: <strong id="summary-low-income"></strong></span>
                    <span>Total Value: <strong id="summary-total-value"></strong></span>
                 </div>
            </div>
            <div class="comparison-grid">
                <div class="result-column">
                    <h3 class="column-title">Current Rules (Estimate)</h3>
                    <div class="space-y-1">
                         <div class="result-item">
                            <span class="result-label">Tax on Abandoned Prop.:</span>
                            <span id="current-abandoned-tax" class="result-value"></span>
                        </div>
                         <hr class="my-1 border-gray-100">
                         <div class="result-item pt-1">
                             <span class="result-label text-gray-500 italic">-- Standard Tax (Maintained) --</span>
                             <span class="result-value"></span>
                         </div>
                        <div class="result-item">
                            <span class="result-label">Value Considered:</span>
                            <span id="current-maintained-value" class="result-value"></span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Threshold:</span>
                            <span id="current-threshold" class="result-value"></span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Taxable Base:</span>
                            <span id="current-taxable-base" class="result-value"></span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Standard Tax:</span>
                            <span id="current-initial-tax" class="result-value"></span>
                        </div>
                         <div class="result-item">
                            <span class="result-label">Low-Income Exemption:</span>
                            <span id="current-low-income-status" class="result-value"></span>
                        </div>
                         <hr class="my-1 border-gray-100">
                        <div class="final-tax-item">
                            <span class="final-tax-label">Final Tax (Total):</span>
                            <span id="current-final-tax" class="final-tax-value"></span>
                        </div>
                         <div id="current-minimum-tax-note" class="text-xs text-green-600 text-right hidden pt-1">Total tax waived (€5 rule).</div>
                         <div id="current-low-income-note" class="text-xs text-green-600 text-right hidden pt-1">Standard tax €0 (low-income).</div>
                    </div>
                </div>
                <div class="result-column">
                    <h3 class="column-title">Proposed 2026 Rules (Estimate)</h3>
                     <div class="space-y-1">
                          <div class="result-item">
                            <span class="result-label">Tax on Abandoned Prop.:</span>
                            <span id="proposed-abandoned-tax" class="result-value"></span>
                        </div>
                         <hr class="my-1 border-gray-100">
                         <div class="result-item pt-1">
                              <span class="result-label text-gray-500 italic">-- Standard Tax (Maintained) --</span>
                              <span class="result-value"></span>
                         </div>
                         <div class="result-item">
                            <span class="result-label">Value Considered:</span>
                            <span id="proposed-maintained-value" class="result-value"></span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Threshold:</span>
                            <span id="proposed-threshold" class="result-value"></span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Taxable Base:</span>
                            <span id="proposed-taxable-base" class="result-value"></span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Tax Before Relief:</span>
                            <span id="proposed-initial-tax" class="result-value"></span>
                        </div>
                         <div class="result-item">
                            <span class="result-label">Primary Res. Relief:</span>
                            <span id="proposed-relief-amount" class="result-value"></span>
                        </div>
                         <div class="result-item">
                            <span class="result-label">Low-Income Exemption:</span>
                            <span id="proposed-low-income-status" class="result-value"></span>
                        </div>
                         <hr class="my-1 border-gray-100">
                        <div class="final-tax-item">
                            <span class="final-tax-label">Final Tax (Total):</span>
                            <span id="proposed-final-tax" class="final-tax-value"></span>
                        </div>
                         <div id="proposed-minimum-tax-note" class="text-xs text-green-600 text-right hidden pt-1">Total tax waived (€5 rule).</div>
                         <div id="proposed-low-income-note" class="text-xs text-green-600 text-right hidden pt-1">Standard tax €0 (low-income).</div>
                    </div>
                </div>
            </div>
            <div id="summary-comparison" class="summary-section hidden">
                <h3 class="summary-title">Estimated Change in Annual Tax</h3>
                <span id="summary-change-value" class="summary-value"></span>
                <span id="summary-change-percentage" class="block text-sm text-indigo-700"></span>
            </div>

             <div class="text-center mt-8">
                 <button id="toggle-explanation-btn" type="button" class="btn-secondary">
                     <i class="fas fa-book-open mr-2"></i> Show Calculation Explanation
                 </button>
             </div>

             <div id="explanation-section" class="hidden">
                 </div>

             <div class="note">
                <strong>Disclaimer:</strong> This calculator provides an *estimate*.
                <ul>
                    <li>Actual tax liability depends on official property valuations ('mokestinė vertė') by Registrų Centras and the specific tax rates and classifications (including for abandoned/neglected property) set by your local municipality. Valuations are expected to increase significantly for 2026.</li>
                    <li>The reform proposal must still be approved by the Seimas and could change.</li>
                    <li>The primary residence relief calculation is simplified (as noted in the explanation). Low-income exemptions might have different application procedures or conditions than assumed here.</li>
                    <li>The tax on abandoned property is calculated separately at the specified municipal rate and added to the standard tax calculated on maintained properties. Standard reliefs do not apply to the abandoned property tax portion, and municipalities may have specific rules regarding exemptions for such properties.</li>
                    <li>This calculator does not cover commercial property, certain land types, or other specific cases. Consult official sources (VMI, Registrų Centras, your municipality) for definitive information.</li>
                </ul>
            </div>

            <div class="resources">
                <h4>Official Resources & Finding Property Value</h4>
                <ul>
                    <li>
                        <strong>Finding Property Taxable Value ('Mokestinė Vertė'):</strong> The official taxable value used for calculations is determined by the Centre of Registers (Registrų Centras). Property owners can usually find this value by logging into the <a href="https://www.registrucentras.lt/savitarna/" target="_blank" rel="noopener noreferrer">Registrų Centras e-services portal</a> using electronic authentication (e.g., mobile signature, Smart-ID, e-banking). Look for sections related to "Nekilnojamasis turtas" (Real Estate) or "Masinis vertinimas" (Mass Valuation).
                    </li>
                    <li>
                        <strong>State Tax Inspectorate (VMI):</strong> For general information about Real Estate Tax rules, declarations, and payments. Search for "Nekilnojamojo turto mokestis" on <a href="https://www.vmi.lt/" target="_blank" rel="noopener noreferrer">www.vmi.lt</a>.
                    </li>
                     <li>
                        <strong>Ministry of Finance (Finansų Ministerija):</strong> For information on the proposed tax reform package (search for "Mokestinių pasiūlymų paketas" or "NT reforma"): <a href="https://finmin.lrv.lt/" target="_blank" rel="noopener noreferrer">finmin.lrv.lt</a>. (See also the specific FAQ link in the source document: <a href="https://finmin.lrv.lt/lt/aktualus-valstybes-finansu-duomenys/mokestiniu-pasiulymu-paketas/nt-duk/" target="_blank" rel="noopener noreferrer">NT Reform FAQ</a>)
                    </li>
                     <li>
                        <strong>Current Law on Real Estate Tax:</strong> The official text of the current law ("Nekilnojamojo turto mokesčio įstatymas") can be found on the official Register of Legal Acts: <a href="https://www.e-tar.lt/" target="_blank" rel="noopener noreferrer">www.e-tar.lt</a>.
                    </li>
                     <li>
                        <strong>LRT Article on Proposed Tax (April 2025):</strong> <a href="https://www.lrt.lt/naujienos/verslas/4/2538574/naujasis-nt-mokescio-projektas-kiek-tektu-susimoketi-uz-busta" target="_blank" rel="noopener noreferrer">Naujasis NT mokesčio projektas: kiek tektų susimokėti už būstą</a>
                    </li>
                    <li>
                        <strong>Local Municipality:</strong> Contact your local municipality (Savivaldybė) for specific information on the tax rate applied to abandoned/neglected properties in your area and the criteria used for classification.
                    </li>
                </ul>
            </div>

        </div>
    </div>
    <script>
        // --- Helper Functions ---
        /**
         * Formats a number as Euro currency according to Lithuanian locale.
         * @param {number} value - The number to format.
         * @returns {string} Formatted currency string.
         */
        function formatCurrency(value) {
            return `€${value.toLocaleString('lt-LT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        // --- Get Input Values ---
        /**
         * Reads all input fields from the form and returns an object containing the values.
         * Performs basic parsing and default setting.
         * @returns {object} Object containing all input values and derived values.
         */
        function getInputs() {
             const primaryResidenceValue = parseFloat(document.getElementById('primary-residence-value').value) || 0;
             const otherPropertiesValue = parseFloat(document.getElementById('other-properties-value').value) || 0;
             const abandonedValue = parseFloat(abandonedValueInput.value) || 0;
             const municipalRate = (abandonedValue > 0) ? (parseFloat(municipalRateInput.value) || 3) : 0;
             const nonAbandonedValue = primaryResidenceValue + otherPropertiesValue;
             const totalValue = nonAbandonedValue + abandonedValue;
             const numOwners = parseInt(document.getElementById('num-owners').value) || 1;
             const isFamilyAdjusted = document.getElementById('family-status').checked;
             const isLowIncome = document.getElementById('low-income').checked;

             return {
                primaryResidenceValue, otherPropertiesValue, abandonedValue, municipalRate,
                nonAbandonedValue, totalValue, numOwners, isFamilyAdjusted, isLowIncome
             };
        }


        // --- Event Listener for Abandoned Value Input ---
        const abandonedValueInput = document.getElementById('abandoned-value');
        const abandonedRateSection = document.getElementById('abandoned-rate-section');
        const municipalRateInput = document.getElementById('municipal-rate');

        abandonedValueInput.addEventListener('input', function() {
            const value = parseFloat(abandonedValueInput.value) || 0;
            if (value > 0) {
                abandonedRateSection.classList.remove('hidden');
            } else {
                abandonedRateSection.classList.add('hidden');
                municipalRateInput.value = 3;
            }
        });

        // --- Event Listener for Toggle Explanation Button ---
        const toggleExplanationBtn = document.getElementById('toggle-explanation-btn');
        const explanationSection = document.getElementById('explanation-section');
        let explanationVisible = false;

        toggleExplanationBtn.addEventListener('click', function() {
            explanationVisible = !explanationVisible;
            const icon = toggleExplanationBtn.querySelector('i'); // Find icon within button

            if (explanationVisible) {
                generateAndShowExplanation();
                toggleExplanationBtn.textContent = 'Hide Explanation';
                // Add icon back when showing explanation
                if (!icon) { // Prevent adding multiple icons
                   toggleExplanationBtn.insertAdjacentHTML('afterbegin', '<i class="fas fa-book-open mr-2"></i>');
                }
            } else {
                explanationSection.classList.add('hidden');
                explanationSection.innerHTML = '';
                toggleExplanationBtn.textContent = 'Show Calculation Explanation';
                 // Remove icon when hiding explanation
                 if(icon) icon.remove();
            }
        });

        // --- Generate and Display Explanation (Plain Text Version with Columns) ---
        /**
         * Generates the HTML content for the explanation section based on current inputs
         * and displays it. Uses plain English and a two-column layout for comparison.
         * Incorporates clarifications based on review feedback. Adds percentage symbols.
         */
        function generateAndShowExplanation() {
            const inputs = getInputs();
            let explanationHTML = '<h3>Calculation Explanation</h3>';

            // --- 1. Abandoned Property Tax (Common) ---
            const abandonedTax = inputs.abandonedValue * (inputs.municipalRate / 100);
            if (inputs.abandonedValue > 0) {
                explanationHTML += `
                    <h4>1. Tax on Abandoned Property (Applies to Both Scenarios)</h4>
                    <p>This tax applies directly to the value of property classified as abandoned/neglected, using the rate set by the municipality (${inputs.municipalRate.toFixed(1)}%). It's calculated first and separately. Standard reliefs and exemptions (like Primary Residence Relief or Low Income Exemption) calculated on maintained property do <strong>not</strong> apply to this tax portion. Municipalities may also have specific rules overriding standard exemptions for listed abandoned properties.</p>
                    <div class="calculation-step">
                        <span>Abandoned Value &times; (Municipal Rate / 100)</span>
                        <span>${formatCurrency(inputs.abandonedValue)} &times; (${inputs.municipalRate.toFixed(1)}% / 100) = ${formatCurrency(abandonedTax)}</span>
                    </div>`;
            } else {
                 explanationHTML += `<h4>1. Tax on Abandoned Property</h4><p class="note-text">No abandoned property value entered, so this tax is €0.</p>`;
            }

            // --- 2. Standard Tax Calculation Comparison (Columns) ---
            explanationHTML += `<p class="mt-4">The following compares how the tax on your <strong>maintained properties</strong> (Total Maintained Value = ${formatCurrency(inputs.nonAbandonedValue)}) is calculated under each set of rules:</p>`;
            explanationHTML += `<div class="explanation-grid">`; // Start grid

            // --- Left Column: Current Rules ---
            let currentExplanationHTML = `<div class="explanation-column">`;
            currentExplanationHTML += `<h4>Standard Tax (Current Rules)</h4>`;
            const currentThrInd = inputs.isFamilyAdjusted ? 200000 : 150000;
            const currentThrTot = currentThrInd * inputs.numOwners;
            currentExplanationHTML += `
                <p><strong>a) Threshold:</strong></p>
                <div class="calculation-step">
                    <span>Individual Threshold (${inputs.isFamilyAdjusted ? 'Family Adj. €200k' : 'Standard €150k'})</span>
                    <span>${formatCurrency(currentThrInd)}</span>
                </div>
                <div class="calculation-step">
                    <span>Total Threshold (Individual &times; Owners)</span>
                    <span>${formatCurrency(currentThrInd)} &times; ${inputs.numOwners} = ${formatCurrency(currentThrTot)}</span>
                </div>`;
            const currentBase = Math.max(0, inputs.nonAbandonedValue - currentThrTot);
            currentExplanationHTML += `
                <p><strong>b) Taxable Base:</strong></p>
                <div class="calculation-step">
                     <span>Max(0, Maintained Val. - Threshold)</span>
                     <span>Max(0, ${formatCurrency(inputs.nonAbandonedValue)} - ${formatCurrency(currentThrTot)}) = ${formatCurrency(currentBase)}</span>
                </div>`;
            const currentStdResult = calculateStandardTaxCurrent(inputs);
            if (currentBase > 0) {
                 currentExplanationHTML += `<p><strong>c) Initial Standard Tax:</strong> Calculated using progressive rates on the base:</p>
                    <ul>
                        <li>0.5% on base portion from threshold up to €${(300000 * inputs.numOwners).toLocaleString('lt-LT')}</li>
                        <li>1.0% on base portion from €${(300000 * inputs.numOwners).toLocaleString('lt-LT')} to €${(500000 * inputs.numOwners).toLocaleString('lt-LT')}</li>
                        <li>2.0% on base portion above €${(500000 * inputs.numOwners).toLocaleString('lt-LT')}</li>
                    </ul>
                     <p class="note-text">(Result before exemptions: ${formatCurrency(currentStdResult.initialStandardTax)})</p>`;
            } else {
                 currentExplanationHTML += `<p><strong>c) Initial Standard Tax:</strong> €0 (Taxable Base is €0).</p>`;
            }
             if (inputs.isLowIncome && inputs.primaryResidenceValue > 0) {
                 currentExplanationHTML += `<p><strong>d) Low Income Exemption:</strong> Applied (Standard tax reduced to €0). <span class='note-text'>(Note: Exact conditions may vary).</span></p>`;
             } else {
                  currentExplanationHTML += `<p class="note-text"><strong>d) Low Income Exemption:</strong> Not applied.</p>`;
             }
             currentExplanationHTML += `<div class="calculation-step mt-2"><strong>Final Standard Tax (Current):</strong><span>${formatCurrency(currentStdResult.finalStandardTax)}</span></div>`;
            currentExplanationHTML += `</div>`; // End Left Column

            // --- Right Column: Proposed Rules ---
            let proposedExplanationHTML = `<div class="explanation-column">`;
            proposedExplanationHTML += `<h4>Standard Tax (Proposed 2026 Rules)</h4>`;
            const proposedThrInd = inputs.isFamilyAdjusted ? 50000 : 40000;
            const proposedThrTot = proposedThrInd * inputs.numOwners;
            proposedExplanationHTML += `
                <p><strong>a) Threshold:</strong></p>
                 <div class="calculation-step">
                    <span>Individual Threshold (${inputs.isFamilyAdjusted ? 'Family Adj. €50k' : 'Standard €40k'})</span>
                    <span>${formatCurrency(proposedThrInd)}</span>
                </div>
                <div class="calculation-step">
                    <span>Total Threshold (Individual &times; Owners)</span>
                    <span>${formatCurrency(proposedThrInd)} &times; ${inputs.numOwners} = ${formatCurrency(proposedThrTot)}</span>
                </div>`;
            const proposedBase = Math.max(0, inputs.nonAbandonedValue - proposedThrTot);
            proposedExplanationHTML += `
                <p><strong>b) Taxable Base:</strong></p>
                <div class="calculation-step">
                     <span>Max(0, Maintained Val. - Threshold)</span>
                     <span>Max(0, ${formatCurrency(inputs.nonAbandonedValue)} - ${formatCurrency(proposedThrTot)}) = ${formatCurrency(proposedBase)}</span>
                </div>`;
            const proposedStdResult = calculateStandardTaxProposed(inputs);
            if (proposedBase > 0) {
                 const proposedBrackets = inputs.isFamilyAdjusted
                    ? [`0.1% on base up to €${(250000 * inputs.numOwners).toLocaleString('lt-LT')}`, `0.2% on base portion to €${(500000 * inputs.numOwners).toLocaleString('lt-LT')}`, `0.5% on base portion to €${(750000 * inputs.numOwners).toLocaleString('lt-LT')}`, `1.0% on base portion above €${(750000 * inputs.numOwners).toLocaleString('lt-LT')}`]
                    : [`0.1% on base up to €${(200000 * inputs.numOwners).toLocaleString('lt-LT')}`, `0.2% on base portion to €${(400000 * inputs.numOwners).toLocaleString('lt-LT')}`, `0.5% on base portion to €${(600000 * inputs.numOwners).toLocaleString('lt-LT')}`, `1.0% on base portion above €${(600000 * inputs.numOwners).toLocaleString('lt-LT')}`];
                 proposedExplanationHTML += `<p><strong>c) Initial Standard Tax:</strong> Calculated using progressive rates on the base:</p>
                    <ul> ${proposedBrackets.map(b => `<li>${b.replace(/(\d\.\d)/, '$1%')}</li>`).join('')} </ul>
                     <p class="note-text">(Result before relief/exemptions: ${formatCurrency(proposedStdResult.initialStandardTax)})</p>`;
             } else {
                  proposedExplanationHTML += `<p><strong>c) Initial Standard Tax:</strong> €0 (Taxable Base is €0).</p>`;
             }
             if (inputs.primaryResidenceValue > 0 && !inputs.isLowIncome) {
                  const reliefPercent = inputs.isFamilyAdjusted ? 75 : 50;
                  proposedExplanationHTML += `
                    <p><strong>d) Primary Residence Relief (${reliefPercent}%):</strong> Applied. Estimated relief amount subtracted. <span class='note-text'>(Note: This calculator uses a simplified method to estimate the relief amount).</span></p>
                    <div class="calculation-step">
                       <span>Estimated Relief Amount</span>
                       <span>${formatCurrency(proposedStdResult.reliefAmount)}</span>
                    </div>
                    <div class="calculation-step">
                        <span>Tax after Relief</span>
                        <span>${formatCurrency(Math.max(0, proposedStdResult.initialStandardTax - proposedStdResult.reliefAmount))}</span>
                    </div>`;
             } else if (inputs.primaryResidenceValue > 0 && inputs.isLowIncome) {
                  proposedExplanationHTML += `<p class="note-text"><strong>d) Primary Residence Relief:</strong> Not applied (Low Income Exemption takes precedence).</p>`;
             } else {
                 proposedExplanationHTML += `<p class="note-text"><strong>d) Primary Residence Relief:</strong> Not applied (No Primary Residence Value).</p>`;
             }
             if (inputs.isLowIncome && inputs.primaryResidenceValue > 0) {
                 proposedExplanationHTML += `<p><strong>e) Low Income Exemption:</strong> Applied (Standard tax reduced to €0). <span class='note-text'>(Note: Exact conditions may vary).</span></p>`;
             } else {
                 proposedExplanationHTML += `<p class="note-text"><strong>e) Low Income Exemption:</strong> Not applied.</p>`;
             }
             proposedExplanationHTML += `<div class="calculation-step mt-2"><strong>Final Standard Tax (Proposed):</strong><span>${formatCurrency(proposedStdResult.finalStandardTax)}</span></div>`;
            proposedExplanationHTML += `</div>`; // End Right Column

            explanationHTML += currentExplanationHTML + proposedExplanationHTML; // Add columns to main HTML
            explanationHTML += `</div>`; // End grid

            // --- 3. Final Total Tax (Summary) --- (Renumbered from 4)
             explanationHTML += `<h4>3. Final Total Tax (Combining Parts)</h4>`;
             explanationHTML += `<p>The final estimated tax is the sum of the Tax on Abandoned Property (Step 1, calculated before standard reliefs) and the Final Standard Tax for maintained properties (calculated in Step 2). This combined total is then checked against the €5 minimum tax rule.</p>`;

             // Show Current Total calculation clearly split
             explanationHTML += `<h5>Current Rules - Final Sum:</h5>`;
             explanationHTML += `<div class="calculation-step"><span>Tax on Abandoned Property</span><span>${formatCurrency(abandonedTax)}</span></div>`;
             explanationHTML += `<div class="calculation-step"><span>+ Final Standard Tax (Current)</span><span>${formatCurrency(currentStdResult.finalStandardTax)}</span></div>`;
             explanationHTML += `<div class="calculation-step sum-step"><span>= Preliminary Total Tax (Current)</span><span>${formatCurrency(abandonedTax + currentStdResult.finalStandardTax)}</span></div>`;

             // Show Proposed Total calculation clearly split
             explanationHTML += `<h5>Proposed Rules - Final Sum:</h5>`;
             explanationHTML += `<div class="calculation-step"><span>Tax on Abandoned Property</span><span>${formatCurrency(abandonedTax)}</span></div>`;
             explanationHTML += `<div class="calculation-step"><span>+ Final Standard Tax (Proposed)</span><span>${formatCurrency(proposedStdResult.finalStandardTax)}</span></div>`;
             explanationHTML += `<div class="calculation-step sum-step"><span>= Preliminary Total Tax (Proposed)</span><span>${formatCurrency(abandonedTax + proposedStdResult.finalStandardTax)}</span></div>`;

             explanationHTML += `<p class="note-text mt-3"><strong>Minimum Tax Rule:</strong> If the Preliminary Total Tax shown above is greater than €0 but less than or equal to €5, the final payable tax shown in the main results table becomes €0.</p>`;


            // --- Display the generated HTML ---
            explanationSection.innerHTML = explanationHTML; // Set the generated HTML
            explanationSection.classList.remove('hidden'); // Make the section visible

        }


        // --- Main Calculation Logic ---
        /**
         * Orchestrates the tax calculation process.
         * Gets inputs, calculates abandoned tax, calculates standard tax for both scenarios,
         * combines results, applies minimum tax rule, and triggers display update.
         */
        function calculateTaxes() {
            const inputs = getInputs(); // Use helper to get all inputs

            // Calculate tax on abandoned property (applies identically to both scenarios)
            const abandonedTax = inputs.abandonedValue * (inputs.municipalRate / 100);

            // Calculate standard tax component for current rules
            const currentStandardResult = calculateStandardTaxCurrent(inputs);
            // Calculate standard tax component for proposed rules
            const proposedStandardResult = calculateStandardTaxProposed(inputs);

            // Combine abandoned tax + standard tax for current rules
            const currentFinalTax = abandonedTax + currentStandardResult.finalStandardTax;
            // Combine abandoned tax + standard tax for proposed rules
            const proposedFinalTax = abandonedTax + proposedStandardResult.finalStandardTax;

            // Apply minimum tax rule to the *total* combined tax for current rules
            let currentTotalTax = currentFinalTax;
            let currentMinRuleApplied = false;
            if (currentTotalTax > 0 && currentTotalTax <= 5) {
                currentTotalTax = 0;
                currentMinRuleApplied = true;
            }

            // Apply minimum tax rule to the *total* combined tax for proposed rules
            let proposedTotalTax = proposedFinalTax;
            let proposedMinRuleApplied = false;
            if (proposedTotalTax > 0 && proposedTotalTax <= 5) {
                proposedTotalTax = 0;
                proposedMinRuleApplied = true;
            }

            // Prepare final result objects for display function
            const currentResult = {
                ...currentStandardResult, // Includes threshold, base, standard tax details
                abandonedTax, // Tax specifically on abandoned property
                finalTotalTax: currentTotalTax, // Final combined tax after min rule
                minimumTaxRuleApplied: currentMinRuleApplied // Flag if min rule was applied
            };
            const proposedResult = {
                 ...proposedStandardResult, // Includes threshold, base, standard tax, relief details
                 abandonedTax, // Tax specifically on abandoned property
                 finalTotalTax: proposedTotalTax, // Final combined tax after min rule
                 minimumTaxRuleApplied: proposedMinRuleApplied // Flag if min rule was applied
            };

            // Pass inputs and results to display function
            displayResults(inputs, currentResult, proposedResult);

             // If explanation was visible when recalculating, hide it until explicitly shown again
             // This prevents showing outdated explanations if inputs change.
             if (explanationVisible) {
                 explanationSection.classList.add('hidden');
                 explanationSection.innerHTML = ''; // Clear content
                 toggleExplanationBtn.textContent = 'Show Calculation Explanation';
                 explanationVisible = false; // Reset visibility state
             }
        }

        // --- Calculate STANDARD Tax based on CURRENT Rules (for Non-Abandoned Property) ---
        /**
         * Calculates the standard real estate tax based on the CURRENT rules (pre-2026).
         * Applies only to the value of non-abandoned properties.
         * @param {object} inputs - Object containing all necessary input values.
         * @returns {object} Object containing calculation details for current standard tax.
         */
        function calculateStandardTaxCurrent(inputs) {
            // Destructure needed values from the input object
            const { nonAbandonedValue, numOwners, isFamilyAdjusted, primaryResidenceValue, isLowIncome } = inputs;

            // Determine the correct threshold per owner based on family status
            // ** CORRECTED based on review: Family adjustment threshold is 200,000 EUR **
            const thresholdPerOwner = isFamilyAdjusted ? 200000 : 150000;
            // Calculate the total threshold for all owners
            const totalThreshold = thresholdPerOwner * numOwners;
            // Calculate the taxable base: value above the threshold (cannot be negative)
            const taxableBase = Math.max(0, nonAbandonedValue - totalThreshold);

            // Calculate the initial tax using progressive rates if the base is positive
            let initialStandardTax = 0;
            if (taxableBase > 0) {
                 // Rate 1: 0.5% on base between threshold and €300k (per owner equivalent)
                 const limit1 = 300000 * numOwners; // Effective limit for 0.5% bracket
                 const baseInBracket1 = Math.min(taxableBase, Math.max(0, limit1 - totalThreshold));
                 initialStandardTax += baseInBracket1 * 0.005;

                 // Rate 2: 1% on base between €300k and €500k (per owner equivalent)
                 const limit2 = 500000 * numOwners; // Effective limit for 1% bracket
                 const baseInBracket2 = Math.min(Math.max(0, taxableBase - baseInBracket1), Math.max(0, limit2 - limit1));
                 initialStandardTax += baseInBracket2 * 0.01;

                 // Rate 3: 2% on base exceeding €500k (per owner equivalent)
                 const baseInBracket3 = Math.max(0, taxableBase - baseInBracket1 - baseInBracket2);
                 initialStandardTax += baseInBracket3 * 0.02;
            }

            // Apply low-income exemption if applicable
            let finalStandardTax = initialStandardTax;
            let lowIncomeApplied = false;
            // Check if low income status is checked AND a primary residence exists
            if (isLowIncome && primaryResidenceValue > 0) {
                finalStandardTax = 0; // Waive the standard tax portion
                lowIncomeApplied = true;
            }

            // Return calculated details for this scenario
            return {
                threshold: totalThreshold,
                taxableBase: taxableBase,
                initialStandardTax: initialStandardTax, // Tax before low-income check
                finalStandardTax: finalStandardTax, // Tax after low-income check
                lowIncomeApplied: lowIncomeApplied, // Flag if exemption was applied
                valueConsidered: nonAbandonedValue // Value used for this calculation
            };
        }

        // --- Calculate STANDARD Tax based on PROPOSED 2026 Rules (for Non-Abandoned Property) ---
         /**
         * Calculates the standard real estate tax based on the PROPOSED 2026 rules.
         * Applies only to the value of non-abandoned properties. Includes primary residence relief.
         * @param {object} inputs - Object containing all necessary input values.
         * @returns {object} Object containing calculation details for proposed standard tax.
         */
        function calculateStandardTaxProposed(inputs) {
             // Destructure needed values
             const { nonAbandonedValue, numOwners, isFamilyAdjusted, primaryResidenceValue, isLowIncome } = inputs;

            // Determine proposed threshold per owner
            const thresholdPerOwner = isFamilyAdjusted ? 50000 : 40000;
            const totalThreshold = thresholdPerOwner * numOwners;
            // Calculate proposed taxable base
            const taxableBase = Math.max(0, nonAbandonedValue - totalThreshold);

            // Calculate initial tax using proposed progressive rates
            let initialStandardTax = 0;
            let remainingBase = taxableBase;
            // Define proposed brackets based on family status
            const brackets = isFamilyAdjusted
                ? [ // Family Adjusted Brackets (€50k threshold base)
                    { limit: 250000, rate: 0.001 }, { limit: 500000, rate: 0.002 }, { limit: 750000, rate: 0.005 }, { limit: Infinity, rate: 0.01 } ]
                : [ // Standard Brackets (€40k threshold base)
                    { limit: 200000, rate: 0.001 }, { limit: 400000, rate: 0.002 }, { limit: 600000, rate: 0.005 }, { limit: Infinity, rate: 0.01 } ];

            let lowerBoundValue = totalThreshold; // Start calculating from the total threshold value

            // Iterate through brackets to calculate tax slice by slice
            for (const bracket of brackets) {
                // Determine the upper value limit for this bracket, adjusted for owners
                const effectiveBracketLimitValue = bracket.limit * numOwners;
                // Calculate the portion of the *total maintained value* that falls within this bracket's range
                const valueInBracketRange = Math.max(0, Math.min(nonAbandonedValue, effectiveBracketLimitValue) - lowerBoundValue);

                // If there's value in this range and still taxable base remaining...
                if (valueInBracketRange > 0 && remainingBase > 0) {
                    // Calculate tax only on the portion of the *taxable base* corresponding to this value range
                    const baseInBracket = Math.min(remainingBase, valueInBracketRange);
                    initialStandardTax += baseInBracket * bracket.rate;
                    remainingBase -= baseInBracket; // Reduce remaining base
                }

                lowerBoundValue = effectiveBracketLimitValue; // Set lower bound for the next bracket
                if (remainingBase <= 0) break; // Stop if entire base has been taxed
            }

            // Apply Primary Residence Relief (if applicable)
            let reliefAmount = 0;
            let finalStandardTax = initialStandardTax; // Start with the calculated tax
            let reliefPercentageText = "";

            // Relief applies only if there's a primary residence and owner is NOT low income
            if (primaryResidenceValue > 0 && !isLowIncome) {
                // Determine relief percentage based on family status
                const reliefPercentage = isFamilyAdjusted ? 0.75 : 0.50;
                reliefPercentageText = `(${isFamilyAdjusted ? '75%' : '50%'})`;
                // Consider PR value up to the cap for relief calculation
                const prValueForRelief = Math.min(primaryResidenceValue, 450000);

                // --- Simplified Relief Calculation ---
                // Estimate tax *as if* the primary residence (capped) was the only property
                let hypotheticalTaxOnPR = 0;
                // Calculate base for this hypothetical scenario
                const hypotheticalPRTaxableBase = Math.max(0, prValueForRelief - totalThreshold);
                let remainingHypotheticalBase = hypotheticalPRTaxableBase;
                let hypotheticalLowerBoundValue = totalThreshold;

                // Apply progressive rates to the hypothetical base
                 for (const bracket of brackets) {
                    const effectiveBracketLimitValue = bracket.limit * numOwners;
                    const valueInBracketRange = Math.max(0, Math.min(prValueForRelief, effectiveBracketLimitValue) - hypotheticalLowerBoundValue);

                    if (valueInBracketRange > 0 && remainingHypotheticalBase > 0) {
                        const baseInBracket = Math.min(remainingHypotheticalBase, valueInBracketRange);
                        hypotheticalTaxOnPR += baseInBracket * bracket.rate;
                        remainingHypotheticalBase -= baseInBracket;
                    }
                    hypotheticalLowerBoundValue = effectiveBracketLimitValue;
                    if (remainingHypotheticalBase <= 0) break;
                }
                // Calculate the relief amount based on the hypothetical tax
                reliefAmount = hypotheticalTaxOnPR * reliefPercentage;
                // Apply the relief to the initial standard tax (cannot go below zero)
                finalStandardTax = Math.max(0, initialStandardTax - reliefAmount);
            }

            // Apply Low-Income Exemption (overrides relief if applicable)
            let lowIncomeApplied = false;
            if (isLowIncome && primaryResidenceValue > 0) {
                finalStandardTax = 0; // Standard tax becomes 0
                reliefAmount = 0; // No separate relief needed if exempt
                lowIncomeApplied = true;
                 reliefPercentageText = ""; // Clear relief text
            }

            // Return calculated details for proposed scenario
            return {
                threshold: totalThreshold,
                taxableBase: taxableBase,
                initialStandardTax: initialStandardTax, // Standard tax before relief/exemption
                reliefAmount: reliefAmount, // Calculated relief amount
                reliefPercentageText: reliefPercentageText, // Text indicating relief %
                finalStandardTax: finalStandardTax, // Standard tax after relief/exemption
                lowIncomeApplied: lowIncomeApplied, // Flag if exemption applied
                valueConsidered: nonAbandonedValue // Value used for this calculation
            };
        }


        // --- Display Results ---
        /**
         * Updates the HTML table and summary sections with the calculated results.
         * @param {object} inputs - The processed input values.
         * @param {object} current - The calculated results for the current rules.
         * @param {object} proposed - The calculated results for the proposed rules.
         */
        function displayResults(inputs, current, proposed) {
            const resultsDiv = document.getElementById('results');
            const summaryComparisonDiv = document.getElementById('summary-comparison');
            const municipalRateSpan = document.getElementById('summary-municipal-rate-span');


            // Display Input Summary section
            document.getElementById('summary-pr-value').textContent = formatCurrency(inputs.primaryResidenceValue);
            document.getElementById('summary-other-value').textContent = formatCurrency(inputs.otherPropertiesValue);
            document.getElementById('summary-abandoned-value').textContent = formatCurrency(inputs.abandonedValue);
             // Show municipal rate only if abandoned value > 0
             if (inputs.abandonedValue > 0) {
                 document.getElementById('summary-municipal-rate').textContent = inputs.municipalRate.toFixed(1);
                 municipalRateSpan.classList.remove('hidden');
             } else {
                 municipalRateSpan.classList.add('hidden');
             }
            document.getElementById('summary-total-value').textContent = formatCurrency(inputs.totalValue);
            document.getElementById('summary-num-owners').textContent = inputs.numOwners;
            document.getElementById('summary-family-status').textContent = inputs.isFamilyAdjusted ? 'Yes' : 'No';
            document.getElementById('summary-low-income').textContent = inputs.isLowIncome ? 'Yes' : 'No';


            // Display Current Rules Results column
            document.getElementById('current-abandoned-tax').textContent = formatCurrency(current.abandonedTax);
            document.getElementById('current-maintained-value').textContent = formatCurrency(current.valueConsidered);
            document.getElementById('current-threshold').textContent = formatCurrency(current.threshold);
            document.getElementById('current-taxable-base').textContent = formatCurrency(current.taxableBase);
            // Display the *final* standard tax (after potential low-income exemption)
            document.getElementById('current-initial-tax').textContent = formatCurrency(current.finalStandardTax);
            document.getElementById('current-low-income-status').textContent = current.lowIncomeApplied ? 'Yes (Standard Tax)' : 'No';
            document.getElementById('current-final-tax').textContent = formatCurrency(current.finalTotalTax); // Show final combined tax
            // Toggle visibility of notes based on flags
            document.getElementById('current-minimum-tax-note').classList.toggle('hidden', !current.minimumTaxRuleApplied);
            document.getElementById('current-low-income-note').classList.toggle('hidden', !current.lowIncomeApplied);


            // Display Proposed Rules Results column
            document.getElementById('proposed-abandoned-tax').textContent = formatCurrency(proposed.abandonedTax);
             document.getElementById('proposed-maintained-value').textContent = formatCurrency(proposed.valueConsidered);
            document.getElementById('proposed-threshold').textContent = formatCurrency(proposed.threshold);
            document.getElementById('proposed-taxable-base').textContent = formatCurrency(proposed.taxableBase);
            // Display standard tax *before* relief/exemption
            document.getElementById('proposed-initial-tax').textContent = formatCurrency(proposed.initialStandardTax);
            document.getElementById('proposed-relief-amount').textContent = `${formatCurrency(proposed.reliefAmount)} ${proposed.reliefPercentageText}`;
            document.getElementById('proposed-low-income-status').textContent = proposed.lowIncomeApplied ? 'Yes (Standard Tax)' : 'No';
            document.getElementById('proposed-final-tax').textContent = formatCurrency(proposed.finalTotalTax); // Show final combined tax
            // Toggle visibility of notes based on flags
            document.getElementById('proposed-minimum-tax-note').classList.toggle('hidden', !proposed.minimumTaxRuleApplied);
            document.getElementById('proposed-low-income-note').classList.toggle('hidden', !proposed.lowIncomeApplied);


            // Display Summary Comparison section (based on final total tax)
            const changeAmount = proposed.finalTotalTax - current.finalTotalTax;
            let changePercentage = 0;
            // Calculate percentage change, handle division by zero
            if (current.finalTotalTax > 0) {
                changePercentage = (changeAmount / current.finalTotalTax) * 100;
            } else if (changeAmount > 0) {
                changePercentage = Infinity; // Indicate increase from zero
            }

            const changeValueElem = document.getElementById('summary-change-value');
            const changePercentageElem = document.getElementById('summary-change-percentage');

            // Format change amount and apply color coding
            changeValueElem.textContent = `${changeAmount >= 0 ? '+' : ''}${formatCurrency(changeAmount)}`;
            changeValueElem.classList.toggle('text-red-600', changeAmount > 0);
            changeValueElem.classList.toggle('text-green-600', changeAmount < 0);
            changeValueElem.classList.toggle('text-indigo-900', changeAmount === 0);

            // Format percentage change text
            if (changePercentage === Infinity) {
                 changePercentageElem.textContent = `(Increase from €0.00)`;
            } else if (current.finalTotalTax === 0 && proposed.finalTotalTax === 0) {
                 changePercentageElem.textContent = `(No change from €0.00)`;
            }
            else {
                 changePercentageElem.textContent = `(${changeAmount >= 0 ? '+' : ''}${changePercentage.toFixed(1)}%)`;
            }

            // Make results sections visible
            resultsDiv.classList.remove('hidden');
            summaryComparisonDiv.classList.remove('hidden');

             // If explanation was visible when recalculating, hide it until explicitly shown again
             if (explanationVisible) {
                 explanationSection.classList.add('hidden');
                 explanationSection.innerHTML = ''; // Clear content
                 toggleExplanationBtn.textContent = 'Show Calculation Explanation';
                 explanationVisible = false; // Reset visibility state
             }
        }


        // --- Form Submit Event Listener ---
        // Triggers tax calculation when the form is submitted
        const form = document.getElementById('tax-form');
        form.addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent default form submission which reloads the page
            calculateTaxes(); // Perform calculation
        });

    </script>
</body>
</html>

